<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ üì¨</h1>
            <a href="index.html" class="text-blue-600 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>
        
        <div id="order-list" class="space-y-4">
            </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zxubzigylpalejienmzi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4dWJ6aWd5bHBhbGVqaWVubXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMjA2MzIsImV4cCI6MjA4NjY5NjYzMn0.3RMM9deY0Cu7y1QxphD2UllEnylAiOhTTftZelcKXYo';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchOrders() {
            const { data, error } = await _supabase
                .from('orders')
                .select('*, jobs(title)')
                .order('created_at', { ascending: false });

            const list = document.getElementById('order-list');
            if (error || !data) { list.innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }

            list.innerHTML = data.map(ord => {
                const isCancelled = ord.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                
                return `
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 ${isCancelled ? 'border-red-500' : 'border-blue-500'} flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="font-bold text-xl">${ord.jobs?.title || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô'}</h3>
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${isCancelled ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">
                                ${ord.status}
                            </span>
                        </div>
                        <p class="text-gray-600 bg-gray-50 p-3 rounded-lg border text-sm italic mb-2">" ${ord.brief_text} "</p>
                        <p class="text-[10px] text-gray-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≤‡∏á: ${new Date(ord.created_at).toLocaleString('th-TH')}</p>
                    </div>

                    <div class="flex flex-col gap-2">
                        ${!isCancelled ? `
                            <button onclick="cancelOrder(${ord.id})" 
                                class="bg-red-50 text-red-600 hover:bg-red-600 hover:text-white border border-red-200 px-4 py-2 rounded-xl font-bold text-sm transition-all shadow-sm">
                                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
                            </button>
                        ` : `
                            <span class="text-gray-400 text-sm font-bold italic">‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                        `}
                    </div>
                </div>
            `;}).join('');
        }

        async function cancelOrder(id) {
            if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

            const { error } = await _supabase
                .from('orders')
                .update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß' })
                .eq('id', id);

            if (error) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            } else {
                alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
                fetchOrders(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
        }

        fetchOrders();
    </script>
</body>
</html>
