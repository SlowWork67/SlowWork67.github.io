<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Chat คุยงาน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <nav class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0">
        <button onclick="window.history.back()" class="text-blue-600 font-bold">← กลับ</button>
        <div class="flex flex-col items-center">
            <h1 class="font-bold text-gray-800">ห้องแชทคุยงาน</h1>
            <select id="my-role" class="text-[10px] border rounded bg-blue-50 px-1">
                <option value="client">มุมมอง: ผู้จ้าง</option>
                <option value="freelancer">มุมมอง: ฟรีแลนซ์</option>
            </select>
        </div>
        <div class="w-10"></div> </nav>

    <div id="chat-win" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
        <p class="text-center text-gray-400 text-sm mt-10">กำลังโหลดข้อความ...</p>
    </div>

    <div class="p-4 bg-white border-t flex gap-2">
        <input type="text" id="msg-input" placeholder="พิมพ์ข้อความที่นี่..." 
            class="flex-1 border p-3 rounded-2xl outline-none focus:border-blue-500 bg-gray-50">
        <button onclick="send()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-blue-700 transition">
            ส่ง
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://zxubzigylpalejienmzi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4dWJ6aWd5bHBhbGVqaWVubXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMjA2MzIsImV4cCI6MjA4NjY5NjYzMn0.3RMM9deY0Cu7y1QxphD2UllEnylAiOhTTftZelcKXYo';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ดึงค่า order_id จาก URL (?order_id=...)
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('order_id');

        async function fetchMsg() {
            if(!orderId) return;
            const { data, error } = await _supabase
                .from('messages')
                .select('*')
                .eq('order_id', orderId)
                .order('created_at', { ascending: true });

            if (data) {
                const win = document.getElementById('chat-win');
                const myRole = document.getElementById('my-role').value;
                
                if(data.length === 0) {
                    win.innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">ยังไม่มีการสนทนา เริ่มพิมพ์ได้เลย!</p>';
                    return;
                }

                win.innerHTML = data.map(m => {
                    const isMe = m.sender_role === myRole;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%]">
                                <p class="text-[9px] text-gray-400 mb-1 ${isMe ? 'text-right' : ''}">
                                    ${m.sender_role === 'client' ? 'ผู้จ้าง' : 'ฟรีแลนซ์'}
                                </p>
                                <div class="p-3 rounded-2xl shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border rounded-tl-none'}">
                                    ${m.content}
                                </div>
                            </div>
                        </div>`;
                }).join('');
                win.scrollTop = win.scrollHeight;
            }
        }

        async function send() {
            const input = document.getElementById('msg-input');
            const role = document.getElementById('my-role').value;
            if(!input.value || !orderId) return;

            const { error } = await _supabase.from('messages').insert([{ 
                order_id: orderId, 
                sender_role: role, 
                content: input.value 
            }]);

            if(!error) {
                input.value = '';
                fetchMsg(); // ดึงข้อความใหม่ทันทีหลังส่ง
            } else {
                alert("ส่งไม่สำเร็จ: " + error.message);
            }
        }

        // ดึงข้อความใหม่ทุก 2 วินาที (Real-time จำลอง)
        setInterval(fetchMsg, 2000);
        fetchMsg();
    </script>
</body>
</html>
